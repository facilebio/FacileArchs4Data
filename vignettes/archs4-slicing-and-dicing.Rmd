---
title: "archs4-slicing-and-dicing"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{archs4-slicing-and-dicing}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)
```

## Overview

In this vignette, we'll provide examples of how to analyze the RNA-seq data
from an SOD1 ALS mouse model ([GSE135539][]).

[GSE135539]: https://www.ncbi.nlm.nih.gov/geo/query/acc.cgi?acc=GSE135539

## Setup

First [download the latest mouse and human archs4 hdf5 files][archs4dl]
and place them both in the same directory. Let's call this directory
`ARCSH4_DIR`.

You can define the global `archs4.data_dir` R option to load these files by
species name, or just point the `Archs4DataSet` constructor to the specific
file itself, like so:

```{r}
# options(archs4.data_dir = Sys.getenv("ARCSH4_DIR"))
library(tidyverse)
library(FacileData)
devtools::load_all(".")

(a4m <- FacileArchs4DataSet("mouse"))
```

[archs4dl]: https://archs4.org/download

## Sample Preparation

First extract the samples from the arcsh4 dataset for [GSE135539][].

```{r}
samples.raw <- samples(a4m) |> 
  filter(dataset == "GSE135539")
```

One challenge with analyzing data fresh off of GEO is manipulating the
sample-level metadata so that samples are annotated for easy analysis.

Sometimes the `characteristics_ch1` column of the sample table has better,
semi-structured information to parse out the sample level covariates.
Other times you have to do manual munging of the `title` column, or others.

The code below provides a quick/dirty dplyr workflow to parse out information
found in the `"title"` column to relevant information (genotype, etc.) for 
downstream analysis.

Note that it is important to keep the h5idx column returned from `samples()`
in order to easily materialize expression data in different ways.

```{r}
descr <- sub("Sample \\d+: ", "", samples.raw$title)
dparts <- strsplit(descr, " ")

samples.clean <- samples.raw |> 
  transmute(
    h5idx,
    dataset,
    sample_id,
    description = descr,
    genotype = ifelse(grepl("wt", descr, ignore.case = TRUE), "WT", "SOD1"),
    treatment = dplyr::case_when(
      grepl("untreated", descr, ignore.case = TRUE) ~ "untreated",
      grepl("control", descr, ignore.case = TRUE) ~ "untreated",
      grepl("shrna", descr, ignore.case = TRUE) ~ "shRNA",
      grepl("sham", descr, ignore.case = TRUE) ~ "sham",
      .default = "wtf"),
    region = sapply(dparts, tail, 1),
    subject_id = sapply(dparts, \(x) paste0("m", x[length(x) - 1])),
    batch = ifelse(grepl("Batch 1", characteristics_ch1), "b1", "b2")
  ) |>
  dplyr::mutate(
    group = paste(region, genotype, treatment, sep = "__"),
    genotype = factor(genotype) |> relevel("WT"),
    treatment = factor(treatment, c("untreated", "sham", "shRNA")),
    .after = "sample_id") |>
  dplyr::arrange(region, genotype, treatment) |>
  dplyr::mutate(group = factor(group, unique(group)))
```

```{r}
head(samples.clean) |> 
  select(sample_id, group, genotype, region)
```


Now, with this data.frame, you can easily materialize a DGEList to perform
"standard" analysis using edgeR, like so:

```{r}
y <- biocbox(samples.clean, class = "DGEList")
head(y$samples[,1:5])
```

And you can also use the FacileAnalysis / FacileAnalysisShine packages to
leverage the hybrid code/gui driven analysis.

Here we'll perform a DGE analysis on the SOD1 vs WT mice using the samples
from the lumbar spinal cord

```{r, message=FALSE, warning=FALSE}
library(FacileAnalysisShine)

dge <- samples.clean |> 
  filter(
    treatment == "untreated",
    region == "lumbar"
  ) |> 
  flm_def("genotype", "SOD1", "WT") |> 
  fdge(method = "voom", with_sample_weights = TRUE)
```

Now you can visualize and whatever else "as expected"

```{r}
tidy(dge) |> 
  arrange(desc(logFC)) |> 
  filter(padj <= 0.05) |> 
  select(feature_id, name, logFC, padj, pval)
```

```{r}
viz(dge, filter(tidy(dge), name == "Cst7"))
```

Or drop down into interactive exploration of these results:

```{r, eval = FALSE}
shine(dge)
```

